<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Professores, Turmas (por Escola) e Votação – SuetamSoft</title>

  <!-- Bootstrap (opcional) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f4f4;
    }

    .container {
      max-width: 980px;
      margin: 2rem auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, .08);
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    .card-bloco {
      margin-bottom: 1rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fafafa;
      position: relative;
    }

    .btn {
      margin-top: .5rem;
    }

    #loginDiv .card {
      border: none;
      box-shadow: 0 2px 12px rgba(0, 0, 0, .1);
      border-radius: 12px;
    }

    #loginDiv .card-header {
      background-color: #007bff;
      color: #fff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      text-align: center;
      font-weight: 500;
      font-size: 1.25rem;
    }

    #loginDiv .card-header.bg-dark {
      background-color: #212529 !important;
    }

    #loginDiv .card-header.bg-success {
      background-color: #28a745 !important;
    }

    .muted {
      color: #6c757d;
      font-size: .9rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 0 .5rem;
      border-radius: 999px;
      background: #e9ecef;
      margin: .25rem;
      font-size: .9rem;
    }

    .chip .remove {
      border: none;
      background: transparent;
      font-size: 1rem;
      line-height: 1;
      margin-left: .35rem;
      cursor: pointer;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width:900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ===== Login ===== -->
    <div id="loginDiv">
      <div class="text-center mb-3">
        <img src="assets/images/logo-suetamsoft.png" alt="Logomarca" style="max-width: 90px; height: auto;" />
      </div>

      <!-- Admin (Mestre) -->
      <div class="card mx-auto" style="max-width:520px;">
        <div class="card-header bg-success text-white">Login Admin (Mestre)</div>
        <div class="card-body">
          <form id="masterLoginForm">
            <div class="mb-3">
              <label for="emailInput" class="form-label">E-mail do Admin</label>
              <input type="email" id="emailInput" class="form-control" placeholder="admin@exemplo.com" required />
            </div>
            <div class="mb-3">
              <label for="passwordInput" class="form-label">Senha</label>
              <input type="password" id="passwordInput" class="form-control" placeholder="Senha do admin" required />
            </div>
            <button type="submit" class="btn btn-success w-100">Entrar</button>
          </form>
          <div id="loginError" class="text-danger mt-2 hidden"></div>
        </div>
      </div>

      <!-- Professor -->
      <div class="card mx-auto mt-3" style="max-width:520px;">
        <div class="card-header bg-dark text-white">Entrar como Professor</div>
        <div class="card-body">
          <form id="teacherLoginForm">
            <div class="mb-3">
              <label for="teacherEmailInput" class="form-label">E-mail</label>
              <input type="email" id="teacherEmailInput" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="teacherPasswordInput" class="form-label">Senha</label>
              <input type="password" id="teacherPasswordInput" class="form-control" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Entrar</button>
          </form>
          <div class="text-center mt-2">
            <button id="teacherForgotBtn" class="btn btn-link">Esqueci minha senha</button>
          </div>
          <div id="teacherLoginError" class="text-danger mt-2 hidden"></div>
        </div>
      </div>

      <p class="text-center mt-3 muted">Use o bloco acima para entrar como <strong>Admin</strong> ou
        <strong>Professor</strong>.
      </p>
    </div>

    <!-- ===== App ===== -->
    <div id="appDiv" class="hidden">
      <!-- Topbar -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div><span id="roleBadge" class="badge bg-secondary">Logado</span></div>
        <div class="d-flex gap-2 align-items-center">
          <a href="#" id="goVoteLink" class="btn btn-outline-info btn-sm">Página de Votação</a>
          <button id="logoutBtn" class="btn btn-outline-secondary">Sair</button>
        </div>
      </div>

      <!-- Menu do Admin -->
      <div id="masterMenuDiv" class="hidden text-center mb-4">
        <button id="btnManageTeachers" class="btn btn-warning">Cadastrar Professores</button>
      </div>

      <!-- Área do Professor -->
      <div id="teacherAreaDiv" class="hidden">
        <div class="mb-4">
          <h5>Área do Professor</h5>
          <div id="teacherInfo" class="mb-3"></div>

          <div class="card-bloco">
            <h6>Minhas Turmas</h6>

            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label for="filterTurmaEscola" class="form-label">Filtrar por escola</label>
                <select id="filterTurmaEscola" class="form-select">
                  <option value="">Todas</option>
                </select>
              </div>
            </div>

            <form id="turmaForm" class="row g-2 mt-1">
              <div class="col-md-5">
                <label for="selectTurmaEscola" class="form-label">Escola</label>
                <select id="selectTurmaEscola" class="form-select" required></select>
                <div id="noSchoolsHelp" class="form-text text-danger d-none">Nenhuma escola cadastrada no seu perfil.
                  Peça ao Admin para adicionar.</div>
              </div>
              <div class="col-md-5">
                <label for="inputTurmaNome" class="form-label">Nome da turma</label>
                <input type="text" id="inputTurmaNome" class="form-control" placeholder="Ex.: 8º A - Manhã" required />
              </div>
              <div class="col-md-2 d-flex">
                <button type="submit" class="btn btn-success w-100 align-self-end" id="btnCriarTurma">Criar
                  Turma</button>
              </div>
            </form>

            <div id="turmasContainer" class="mt-3"></div>
          </div>

          <div id="turmaManagerDiv" class="hidden">
            <div class="d-flex justify-content-between align-items-center">
              <h6 id="turmaTitle">Gerenciando Turma</h6>
              <button id="btnCloseTurma" class="btn btn-sm btn-outline-secondary">Fechar</button>
            </div>
            <div class="grid-2 mt-2">
              <!-- Grupos -->
              <div class="card-bloco">
                <h6>Grupos</h6>
                <form id="grupoForm" class="row g-2">
                  <div class="col-8">
                    <input type="text" id="inputGrupoNome" class="form-control" placeholder="Nome do grupo" required />
                  </div>
                  <div class="col-4">
                    <button type="submit" class="btn btn-primary w-100">Adicionar Grupo</button>
                  </div>
                </form>
                <div id="gruposContainer" class="mt-2"></div>
                <div class="mt-3">
                  <button id="btnFinalizarVotacao" class="btn btn-outline-success w-100">Finalizar Votação</button>
                </div>
                <div id="resultadoVotacao" class="mt-3"></div>
              </div>

              <!-- Alunos -->
              <div class="card-bloco">
                <h6>Alunos</h6>
                <form id="alunoForm" class="row g-2">
                  <div class="col-7">
                    <input type="text" id="inputAlunoNome" class="form-control" placeholder="Nome do aluno" required />
                  </div>
                  <div class="col-5">
                    <button type="submit" class="btn btn-primary w-100">Adicionar Aluno (gera código)</button>
                  </div>
                </form>
                <div class="mt-2">
                  <button id="btnExportAlunos" class="btn btn-outline-success btn-sm">Exportar Códigos (CSV)</button>
                </div>
                <div id="alunosContainer" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gerenciar Professores (Admin) -->
      <div id="manageTeachersDiv" class="hidden">
        <div class="card-bloco">
          <h5>Novo Professor</h5>
          <form id="teacherForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="inputTeacherName" class="form-label">Nome</label>
                <input type="text" id="inputTeacherName" class="form-control" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="inputTeacherEmail" class="form-label">E-mail</label>
                <input type="email" id="inputTeacherEmail" class="form-control" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="inputTeacherPassword" class="form-label">Senha Temporária</label>
                <input type="password" id="inputTeacherPassword" class="form-control" required />
                <div class="form-text">Uma conta será criada com essa senha inicial.</div>
              </div>
              <div class="col-md-3 mb-3">
                <label for="inputTeacherSubject" class="form-label">Matéria</label>
                <input type="text" id="inputTeacherSubject" class="form-control" placeholder="Português" />
              </div>
              <div class="col-md-12 mb-2">
                <label class="form-label">Escolas</label>
                <div class="d-flex gap-2">
                  <input type="text" id="inputTeacherSchool" class="form-control"
                    placeholder="Digite uma escola e clique em Adicionar" />
                  <button type="button" id="btnAddSchool" class="btn btn-outline-primary">Adicionar</button>
                </div>
                <div id="schoolsList" class="mt-2"></div>
              </div>
            </div>
            <button type="submit" class="btn btn-success">Salvar Professor</button>
          </form>
        </div>

        <h5 class="mt-4">Professores Cadastrados</h5>
        <div id="teachersContainer"></div>
      </div>

      <!-- ===== Página de Votação (pública) ===== -->
      <div id="voteDiv" class="hidden">
        <div class="card-bloco">
          <h5>Votação</h5>
          <p class="muted">Digite seu <strong>código de 5 dígitos</strong> para votar. Você só pode votar uma vez.</p>
          <form id="voteCodeForm" class="row g-2">
            <div class="col-md-6">
              <input type="text" id="voteCodeInput" class="form-control mono" placeholder="Ex.: 04257" maxlength="5"
                required />
            </div>
            <div class="col-md-3">
              <button type="submit" class="btn btn-primary w-100">Validar Código</button>
            </div>
            <div class="col-md-3">
              <button type="button" id="btnBackFromVote" class="btn btn-outline-secondary w-100">Voltar</button>
            </div>
          </form>

          <div id="voteStep2" class="hidden mt-3">
            <div id="voteStudentInfo" class="mb-2"></div>
            <form id="voteForm">
              <div id="voteGroupsContainer" class="mb-2"></div>
              <button type="submit" class="btn btn-success">Confirmar Voto</button>
            </form>
          </div>

          <div id="voteMsg" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // 1) Firebase
    // -----------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBXJTaaWTMghBpCAhqUXRnp6TX_BDDor9Y",
      authDomain: "votacao-68105.firebaseapp.com",
      projectId: "votacao-68105",
      storageBucket: "votacao-68105.firebasestorage.app",
      messagingSenderId: "22538322070",
      appId: "1:22538322070:web:fd9ae3a41b843dc9ebc2b7",
      measurementId: "G-R3CG0E8103"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const MASTER_EMAIL = "adminvotacao@gmail.com";

    // app secundário para criar professores
    let secondaryApp;
    try { secondaryApp = firebase.app("Secondary"); }
    catch (e) { secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary"); }
    const secondaryAuth = secondaryApp.auth();

    // -----------------------------
    // 2) DOM refs
    // -----------------------------
    const goVoteLink = document.getElementById("goVoteLink");

    const loginDiv = document.getElementById("loginDiv");
    const masterLoginForm = document.getElementById("masterLoginForm");
    const loginError = document.getElementById("loginError");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");

    const teacherLoginForm = document.getElementById("teacherLoginForm");
    const teacherEmailInput = document.getElementById("teacherEmailInput");
    const teacherPasswordInput = document.getElementById("teacherPasswordInput");
    const teacherLoginError = document.getElementById("teacherLoginError");
    const teacherForgotBtn = document.getElementById("teacherForgotBtn");

    const appDiv = document.getElementById("appDiv");
    const logoutBtn = document.getElementById("logoutBtn");
    const roleBadge = document.getElementById("roleBadge");

    const masterMenuDiv = document.getElementById("masterMenuDiv");
    const btnManageTeachers = document.getElementById("btnManageTeachers");
    const manageTeachersDiv = document.getElementById("manageTeachersDiv");

    const teacherAreaDiv = document.getElementById("teacherAreaDiv");
    const teacherInfo = document.getElementById("teacherInfo");

    const filterTurmaEscola = document.getElementById("filterTurmaEscola");
    const turmaForm = document.getElementById("turmaForm");
    const selectTurmaEscola = document.getElementById("selectTurmaEscola");
    const inputTurmaNome = document.getElementById("inputTurmaNome");
    const btnCriarTurma = document.getElementById("btnCriarTurma");
    const noSchoolsHelp = document.getElementById("noSchoolsHelp");
    const turmasContainer = document.getElementById("turmasContainer");
    const turmaManagerDiv = document.getElementById("turmaManagerDiv");
    const turmaTitle = document.getElementById("turmaTitle");
    const btnCloseTurma = document.getElementById("btnCloseTurma");

    const grupoForm = document.getElementById("grupoForm");
    const inputGrupoNome = document.getElementById("inputGrupoNome");
    const gruposContainer = document.getElementById("gruposContainer");

    const alunoForm = document.getElementById("alunoForm");
    const inputAlunoNome = document.getElementById("inputAlunoNome");
    const alunosContainer = document.getElementById("alunosContainer");
    const btnExportAlunos = document.getElementById("btnExportAlunos");

    const teacherForm = document.getElementById("teacherForm");
    const inputTeacherName = document.getElementById("inputTeacherName");
    const inputTeacherEmail = document.getElementById("inputTeacherEmail");
    const inputTeacherPassword = document.getElementById("inputTeacherPassword");
    const inputTeacherSubject = document.getElementById("inputTeacherSubject");
    const inputTeacherSchool = document.getElementById("inputTeacherSchool");
    const btnAddSchool = document.getElementById("btnAddSchool");
    const schoolsListDiv = document.getElementById("schoolsList");
    const teachersContainer = document.getElementById("teachersContainer");
    let currentSchools = [];

    const voteDiv = document.getElementById("voteDiv");
    const voteCodeForm = document.getElementById("voteCodeForm");
    const voteCodeInput = document.getElementById("voteCodeInput");
    const voteStep2 = document.getElementById("voteStep2");
    const voteGroupsContainer = document.getElementById("voteGroupsContainer");
    const voteStudentInfo = document.getElementById("voteStudentInfo");
    const voteForm = document.getElementById("voteForm");
    const voteMsg = document.getElementById("voteMsg");
    const btnBackFromVote = document.getElementById("btnBackFromVote");

    // Estado
    let isMaster = false;
    let currentUser = null;
    let currentProfessorDoc = null;
    let currentTurmaId = null, currentTurmaNome = null, currentTurmaEscola = null;
    let voteStudentDoc = null, voteTurmaId = null, voteAlunoRef = null;

    // -----------------------------
    // 3) Login admin
    // -----------------------------
    masterLoginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.classList.add("hidden");
      try {
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const cred = await auth.signInWithEmailAndPassword(email, password);
        if (cred.user.email.toLowerCase() !== MASTER_EMAIL.toLowerCase()) {
          await auth.signOut(); alert("Acesso negado: somente o e-mail mestre pode entrar aqui."); return;
        }
        isMaster = true; showMasterView(); masterLoginForm.reset();
      } catch (err) {
        console.error(err);
        loginError.textContent = "Erro ao fazer login: " + err.message;
        loginError.classList.remove("hidden");
      }
    });

    // -----------------------------
    // 4) Login professor
    // -----------------------------
    teacherLoginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      teacherLoginError.classList.add("hidden");
      try {
        const email = teacherEmailInput.value.trim();
        const password = teacherPasswordInput.value;
        const cred = await auth.signInWithEmailAndPassword(email, password);
        if (cred.user.email.toLowerCase() === MASTER_EMAIL.toLowerCase()) { isMaster = true; showMasterView(); return; }
        isMaster = false; showTeacherView(cred.user);
      } catch (err) {
        console.error(err);
        teacherLoginError.textContent = "Erro ao entrar: " + err.message;
        teacherLoginError.classList.remove("hidden");
      }
    });

    teacherForgotBtn.addEventListener("click", async () => {
      const email = (teacherEmailInput.value || "").trim();
      if (!email) return alert("Informe seu e-mail no campo acima e clique novamente.");
      try { await auth.sendPasswordResetEmail(email); alert("Enviamos um e-mail para redefinir sua senha."); }
      catch (err) { console.error(err); alert("Não foi possível enviar o e-mail. Verifique o endereço."); }
    });

    // -----------------------------
    // 5) Logout e Auth state
    // -----------------------------
    logoutBtn.addEventListener("click", () => { auth.signOut(); resetToLogin(); });
    auth.onAuthStateChanged(async (user) => {
      currentUser = user;
      if (!user) resetToLogin();
      else if (user.email.toLowerCase() === MASTER_EMAIL.toLowerCase()) { isMaster = true; showMasterView(); }
      else { isMaster = false; showTeacherView(user); }
    });

    // -----------------------------
    // 6) Views
    // -----------------------------
    goVoteLink.addEventListener("click", (e) => { e.preventDefault(); showVoteView(); });
    btnBackFromVote.addEventListener("click", () => {
      voteMsg.innerHTML = ""; voteStep2.classList.add("hidden"); voteCodeInput.value = "";
      if (isMaster) showMasterView(); else showTeacherView(currentUser);
    });

    function showMasterView() {
      loginDiv.classList.add("hidden"); appDiv.classList.remove("hidden");
      roleBadge.textContent = "Admin (Mestre)"; roleBadge.className = "badge bg-success";
      masterMenuDiv.classList.remove("hidden"); manageTeachersDiv.classList.add("hidden");
      teacherAreaDiv.classList.add("hidden"); voteDiv.classList.add("hidden");
    }

    function populateSchoolsSelect(escolasArr) {
      selectTurmaEscola.innerHTML = ""; filterTurmaEscola.innerHTML = '<option value="">Todas</option>';
      if (!escolasArr.length) {
        const opt = document.createElement("option"); opt.value = ""; opt.textContent = "Sem escolas cadastradas";
        selectTurmaEscola.appendChild(opt); selectTurmaEscola.disabled = true; btnCriarTurma.disabled = true;
        noSchoolsHelp.classList.remove("d-none"); return;
      }
      noSchoolsHelp.classList.add("d-none");
      selectTurmaEscola.disabled = false; btnCriarTurma.disabled = false;
      escolasArr.forEach(e => {
        const o1 = document.createElement("option"); o1.value = e; o1.textContent = e; selectTurmaEscola.appendChild(o1);
        const o2 = document.createElement("option"); o2.value = e; o2.textContent = e; filterTurmaEscola.appendChild(o2);
      });
    }

    function showTeacherView(user) {
      loginDiv.classList.add("hidden"); appDiv.classList.remove("hidden");
      roleBadge.textContent = "Professor"; roleBadge.className = "badge bg-primary";
      masterMenuDiv.classList.add("hidden"); manageTeachersDiv.classList.add("hidden"); teacherAreaDiv.classList.remove("hidden"); voteDiv.classList.add("hidden");

      db.collection("professores").where("uid", "==", user.uid).limit(1).get()
        .then(snap => {
          let escolasArr = [];
          if (snap.empty) { teacherInfo.innerHTML = `<strong>${user.email}</strong> (cadastro não localizado)`; currentProfessorDoc = null; }
          else {
            const doc = snap.docs[0]; currentProfessorDoc = doc; const p = doc.data();
            escolasArr = Array.isArray(p.escolas) ? p.escolas : (p.escola ? [p.escola] : []);
            teacherInfo.innerHTML = `<strong>${p.nome}</strong> — ${p.email}<br>Matéria: ${p.materia || "-"} | Escolas: ${escolasArr.length ? escolasArr.join(", ") : "-"} | Ativo: ${p.ativo ? "Sim" : "Não"}`;
            if (p.ativo === false) alert("Seu usuário está desativado. Fale com o administrador.");
          }
          populateSchoolsSelect(escolasArr); loadTurmasList();
        })
        .catch(err => { console.error("Erro ao buscar professor:", err); teacherInfo.textContent = user.email; populateSchoolsSelect([]); loadTurmasList(); });
    }

    function showVoteView() {
      loginDiv.classList.add("hidden"); appDiv.classList.remove("hidden"); voteDiv.classList.remove("hidden");
      masterMenuDiv.classList.add("hidden"); manageTeachersDiv.classList.add("hidden"); teacherAreaDiv.classList.add("hidden");
      voteMsg.innerHTML = ""; voteStep2.classList.add("hidden"); voteCodeInput.value = ""; voteGroupsContainer.innerHTML = ""; voteStudentInfo.innerHTML = "";
      voteStudentDoc = null; voteTurmaId = null; voteAlunoRef = null;
    }

    function resetToLogin() {
      loginDiv.classList.remove("hidden"); appDiv.classList.add("hidden");
      masterMenuDiv.classList.add("hidden"); manageTeachersDiv.classList.add("hidden"); teacherAreaDiv.classList.add("hidden"); voteDiv.classList.add("hidden");
      loginError.classList.add("hidden"); teacherLoginError.classList.add("hidden");
      currentTurmaId = null; currentTurmaNome = null; currentTurmaEscola = null;
    }

    // -----------------------------
    // 7) Admin – Professores
    // -----------------------------
    btnManageTeachers.addEventListener("click", () => {
      manageTeachersDiv.classList.remove("hidden"); teacherAreaDiv.classList.add("hidden"); voteDiv.classList.add("hidden");
      loadTeachersList(); resetSchoolsInput();
    });

    function renderSchoolsChips() {
      schoolsListDiv.innerHTML = ""; if (!currentSchools.length) return;
      currentSchools.forEach((esc, idx) => {
        const chip = document.createElement("span"); chip.className = "chip"; chip.textContent = esc;
        const btn = document.createElement("button"); btn.className = "remove"; btn.type = "button"; btn.setAttribute("aria-label", "Remover escola"); btn.innerHTML = "&times;";
        btn.addEventListener("click", () => { currentSchools.splice(idx, 1); renderSchoolsChips(); });
        chip.appendChild(btn); schoolsListDiv.appendChild(chip);
      });
    }
    function addSchoolFromInput() {
      const val = (inputTeacherSchool.value || "").trim(); if (!val) return;
      const exists = currentSchools.some(e => e.toLowerCase() === val.toLowerCase()); if (!exists) { currentSchools.push(val); renderSchoolsChips(); }
      inputTeacherSchool.value = ""; inputTeacherSchool.focus();
    }
    btnAddSchool.addEventListener("click", addSchoolFromInput);
    inputTeacherSchool.addEventListener("keydown", (ev) => { if (ev.key === "Enter") { ev.preventDefault(); addSchoolFromInput(); } });
    function resetSchoolsInput() { currentSchools = []; inputTeacherSchool.value = ""; renderSchoolsChips(); }

    teacherForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = inputTeacherName.value.trim(); const email = inputTeacherEmail.value.trim(); const senha = inputTeacherPassword.value;
      const materia = (inputTeacherSubject.value || "").trim(); const escolasArr = currentSchools.slice();
      if (!nome || !email || !senha) { alert("Preencha ao menos Nome, E-mail e Senha."); return; }
      try {
        const dup = await db.collection("professores").where("email", "==", email).get();
        if (!dup.empty) { alert("Já existe um professor com esse e-mail."); return; }
      } catch (err) { console.error("Erro ao verificar duplicidade:", err); alert("Erro ao verificar duplicidade."); return; }
      try {
        const userCred = await secondaryAuth.createUserWithEmailAndPassword(email, senha);
        const uid = userCred.user.uid;
        await db.collection("professores").add({ nome, email, uid, materia, escolas: escolasArr, ativo: true, criadoEm: firebase.firestore.FieldValue.serverTimestamp() });
        inputTeacherName.value = ""; inputTeacherEmail.value = ""; inputTeacherPassword.value = ""; inputTeacherSubject.value = ""; resetSchoolsInput();
        loadTeachersList(); alert("Professor cadastrado com sucesso!");
      } catch (err) { console.error("Erro ao criar professor:", err); alert("Erro ao criar professor. Veja o console."); }
    });

    async function loadTeachersList() {
      teachersContainer.innerHTML = "<p>Carregando professores...</p>";
      try {
        const snapshot = await db.collection("professores").orderBy("nome", "asc").get();
        teachersContainer.innerHTML = "";
        if (snapshot.empty) { teachersContainer.innerHTML = "<p>Nenhum professor cadastrado.</p>"; return; }
        snapshot.forEach((docRef) => {
          const p = docRef.data();
          const escolasArr = Array.isArray(p.escolas) ? p.escolas : (p.escola ? [p.escola] : []);
          const escolasStr = escolasArr.length ? escolasArr.join(", ") : "-";
          const card = document.createElement("div"); card.classList.add("card-bloco");
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>${p.nome}</strong> — ${p.email}
                <div class="mt-1" style="font-size:.9rem;color:#555">
                  Matéria: ${p.materia || "-"} | Escolas: ${escolasStr} | UID: ${p.uid || "-"}
                  <br>Ativo: ${p.ativo ? "Sim" : "Não"}
                </div>
              </div>
              <div>
                <button class="btn btn-sm btn-outline-warning me-1 btn-toggle-ativo">${p.ativo ? "Desativar" : "Ativar"}</button>
                <button class="btn btn-sm btn-outline-danger btn-remove-prof">Excluir</button>
              </div>
            </div>`;
          card.querySelector(".btn-remove-prof").addEventListener("click", async () => {
            if (!confirm(`Excluir o professor "${p.nome}" do Firestore?`)) return;
            try { await db.collection("professores").doc(docRef.id).delete(); loadTeachersList(); }
            catch (err) { console.error("Erro ao excluir professor:", err); alert("Erro ao excluir professor."); }
          });
          card.querySelector(".btn-toggle-ativo").addEventListener("click", async () => {
            try { await db.collection("professores").doc(docRef.id).update({ ativo: !p.ativo }); loadTeachersList(); }
            catch (err) { console.error("Erro ao alternar ativo:", err); alert("Erro ao atualizar status."); }
          });
          teachersContainer.appendChild(card);
        });
      } catch (err) { console.error("Erro ao carregar professores:", err); teachersContainer.innerHTML = "<p>Erro ao carregar professores.</p>"; }
    }

    // -----------------------------
    // 8) Turmas (por ESCOLA)
    // -----------------------------
    filterTurmaEscola.addEventListener("change", loadTurmasList);

    turmaForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = inputTurmaNome.value.trim(); const escola = selectTurmaEscola.value;
      if (!nome || !currentUser) return;
      if (!escola) { alert("Selecione uma escola para criar a turma."); return; }
      try {
        await db.collection("turmas").add({ nome, escola, professorUid: currentUser.uid, criadoEm: firebase.firestore.FieldValue.serverTimestamp() });
        inputTurmaNome.value = ""; loadTurmasList();
      } catch (err) { console.error("Erro ao criar turma:", err); alert("Erro ao criar turma."); }
    });

    async function loadTurmasList() {
      turmasContainer.innerHTML = "<p>Carregando turmas...</p>";
      if (!currentUser) return;
      try {
        const snap = await db.collection("turmas").where("professorUid", "==", currentUser.uid).get();
        turmasContainer.innerHTML = "";
        if (snap.empty) { turmasContainer.innerHTML = "<p>Nenhuma turma cadastrada.</p>"; return; }
        let docs = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        docs.sort((a, b) => (b.data.criadoEm?.toMillis?.() ?? 0) - (a.data.criadoEm?.toMillis?.() ?? 0));
        const filtro = filterTurmaEscola.value;
        if (filtro) docs = docs.filter(d => (d.data.escola || "") === filtro);
        if (!docs.length) { turmasContainer.innerHTML = "<p>Nenhuma turma encontrada para o filtro selecionado.</p>"; return; }
        docs.forEach(({ id, data: t }) => {
          const div = document.createElement("div"); div.className = "card-bloco";
          div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>${t.nome}</strong>
                <span class="badge bg-light text-dark ms-2">${t.escola || "-"}</span>
                <span class="muted ms-2">(${id})</span>
              </div>
              <div>
                <button class="btn btn-sm btn-primary me-2 btn-open-turma">Abrir</button>
                <button class="btn btn-sm btn-outline-danger btn-del-turma">Excluir</button>
              </div>
            </div>`;
          div.querySelector(".btn-open-turma").addEventListener("click", () => openTurma(id, t.nome, t.escola));
          div.querySelector(".btn-del-turma").addEventListener("click", async () => {
            if (!confirm(`Excluir a turma "${t.nome}"? Isso não apaga subcoleções automaticamente.`)) return;
            try { await db.collection("turmas").doc(id).delete(); loadTurmasList(); }
            catch (err) { console.error("Erro ao excluir turma:", err); alert("Erro ao excluir turma."); }
          });
          turmasContainer.appendChild(div);
        });
      } catch (err) { console.error("Erro ao listar turmas:", err); turmasContainer.innerHTML = "<p>Erro ao carregar turmas.</p>"; }
    }

    function openTurma(turmaId, nome, escola) {
      currentTurmaId = turmaId; currentTurmaNome = nome; currentTurmaEscola = escola || "-";
      turmaTitle.textContent = `Gerenciando Turma: ${nome} — Escola: ${currentTurmaEscola}`;
      turmaManagerDiv.classList.remove("hidden"); loadGruposList(); loadAlunosList();
    }
    btnCloseTurma.addEventListener("click", () => { currentTurmaId = null; currentTurmaNome = null; currentTurmaEscola = null; turmaManagerDiv.classList.add("hidden"); });

    // -----------------------------
    // 9) Grupos
    // -----------------------------
    grupoForm.addEventListener("submit", async (e) => {
      e.preventDefault(); if (!currentTurmaId) return;
      const nome = inputGrupoNome.value.trim(); if (!nome) return;
      try {
        await db.collection("turmas").doc(currentTurmaId).collection("grupos").add({ nome, votos: 0, criadoEm: firebase.firestore.FieldValue.serverTimestamp() });
        inputGrupoNome.value = ""; loadGruposList();
      } catch (err) { console.error("Erro ao criar grupo:", err); alert("Erro ao criar grupo."); }
    });

    async function loadGruposList() {
  gruposContainer.innerHTML = "<p>Carregando grupos...</p>"; 
  if (!currentTurmaId) return;

  try {
    const snap = await db.collection("turmas")
      .doc(currentTurmaId)
      .collection("grupos")
      .orderBy("criadoEm", "asc")
      .get();

    gruposContainer.innerHTML = "";

    // mostra o botão somente se houver grupos
    document.getElementById("btnFinalizarVotacao").style.display = snap.empty ? "none" : "block";

    if (snap.empty) {
      gruposContainer.innerHTML = "<p>Nenhum grupo cadastrado.</p>";
      return;
    }

    snap.forEach(doc => {
      const g = doc.data();
      const div = document.createElement("div");
      div.className = "d-flex justify-content-between align-items-center border rounded p-2 mb-2";
      div.innerHTML = `
        <div><strong>${g.nome}</strong> — Votos: <span class="mono">${g.votos ?? 0}</span></div>
        <div><button class="btn btn-sm btn-outline-danger btn-del-grupo">Excluir</button></div>`;
      gruposContainer.appendChild(div);
    });

  } catch (err) {
    console.error("Erro ao listar grupos:", err);
    gruposContainer.innerHTML = "<p>Erro ao carregar grupos.</p>";
  }
}

    const btnFinalizarVotacao = document.getElementById("btnFinalizarVotacao");
    const resultadoVotacao = document.getElementById("resultadoVotacao");

    btnFinalizarVotacao.addEventListener("click", async () => {
      if (!currentTurmaId) {
        alert("Nenhuma turma aberta.");
        return;
      }

      try {
        const snap = await db.collection("turmas")
          .doc(currentTurmaId)
          .collection("grupos")
          .orderBy("votos", "desc")
          .get();

        if (snap.empty) {
          resultadoVotacao.innerHTML = `<div class="alert alert-warning">Nenhum grupo cadastrado.</div>`;
          return;
        }

        // Descobre o maior número de votos
        const grupos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const maxVotos = grupos[0].votos || 0;
        const vencedores = grupos.filter(g => (g.votos || 0) === maxVotos);

        // Monta mensagem
        if (maxVotos === 0) {
          resultadoVotacao.innerHTML = `<div class="alert alert-info">Nenhum voto registrado ainda.</div>`;
          return;
        }

        if (vencedores.length === 1) {
          resultadoVotacao.innerHTML = `
        <div class="alert alert-success">
          🏆 Grupo vencedor: <strong>${vencedores[0].nome}</strong> com ${maxVotos} votos!
        </div>`;
        } else {
          const nomes = vencedores.map(g => g.nome).join(", ");
          resultadoVotacao.innerHTML = `
        <div class="alert alert-warning">
          Empate entre: <strong>${nomes}</strong> com ${maxVotos} votos cada!
        </div>`;
        }
      } catch (err) {
        console.error("Erro ao finalizar votação:", err);
        resultadoVotacao.innerHTML = `<div class="alert alert-danger">Erro ao buscar resultados.</div>`;
      }
    });

    // -----------------------------
    // 10) Alunos (com coleção global 'codes')
    // -----------------------------
    alunoForm.addEventListener("submit", async (e) => {
      e.preventDefault(); if (!currentTurmaId) return;
      const nome = inputAlunoNome.value.trim(); if (!nome) return;
      try {
        await createAlunoWithUniqueCode(currentTurmaId, nome);
        inputAlunoNome.value = ""; loadAlunosList();
      } catch (err) {
        console.error("Erro ao criar aluno:", err);
        alert(`Erro ao criar aluno: ${err.code || ''} ${err.message || ''}`);
      }
    });

    async function loadAlunosList() {
      alunosContainer.innerHTML = "<p>Carregando alunos...</p>"; if (!currentTurmaId) return;
      try {
        const snap = await db.collection("turmas").doc(currentTurmaId).collection("alunos").orderBy("criadoEm", "asc").get();
        alunosContainer.innerHTML = ""; if (snap.empty) { alunosContainer.innerHTML = "<p>Nenhum aluno cadastrado.</p>"; return; }
        const table = document.createElement("table"); table.className = "table table-sm";
        table.innerHTML = `<thead><tr><th>Aluno</th><th>Código</th><th>Votou?</th><th>Ações</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector("tbody");
        snap.forEach(doc => {
          const a = doc.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${a.nome}</td>
            <td class="mono">${a.codigo ?? ""}</td>
            <td>${a.isVoto ? "Sim" : "Não"}</td>
            <td><button class="btn btn-sm btn-outline-danger btn-del-aluno">Excluir</button></td>`;
          tr.querySelector(".btn-del-aluno").addEventListener("click", async () => {
            if (!confirm(`Excluir o aluno "${a.nome}"?`)) return;
            try {
              // remover vínculo em /codes/{codigo} também
              const cod = a.codigo;
              await db.collection("turmas").doc(currentTurmaId).collection("alunos").doc(doc.id).delete();
              if (cod) { await db.collection("codes").doc(cod).delete().catch(() => { }); }
              loadAlunosList();
            } catch (err) { console.error("Erro ao excluir aluno:", err); alert("Erro ao excluir aluno."); }
          });
          tbody.appendChild(tr);
        });
        alunosContainer.appendChild(table);
      } catch (err) { console.error("Erro ao listar alunos:", err); alunosContainer.innerHTML = "<p>Erro ao carregar alunos.</p>"; }
    }

    btnExportAlunos.addEventListener("click", async () => {
      if (!currentTurmaId) return;
      try {
        const snap = await db.collection("turmas").doc(currentTurmaId).collection("alunos").orderBy("nome", "asc").get();
        let csv = `"Aluno";"Código";"Votou?"\r\n`;
        snap.forEach(doc => {
          const d = doc.data(); const nome = (d.nome || "").replace(/"/g, '""'); const cod = d.codigo || "";
          csv += `"${nome}";"${cod}";"${d.isVoto ? "Sim" : "Não"}"\r\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" }); const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url;
        const escolaSlug = (currentTurmaEscola || "-").replace(/[^\w\-]+/g, "_");
        const turmaSlug = (currentTurmaNome || currentTurmaId).replace(/[^\w\-]+/g, "_");
        a.download = `alunos_${escolaSlug}_${turmaSlug}.csv`; a.click(); URL.revokeObjectURL(url);
      } catch (err) { console.error("Erro ao exportar:", err); alert("Erro ao exportar."); }
    });

    // Criação de aluno com unicidade via coleção 'codes'
    async function createAlunoWithUniqueCode(turmaId, nome, maxTries = 50) {
      const turmaRef = db.collection("turmas").doc(turmaId);
      const alunosCol = turmaRef.collection("alunos");

      for (let i = 0; i < maxTries; i++) {
        const codigo = String(Math.floor(Math.random() * 100000)).padStart(5, "0");
        const codeRef = db.collection("codes").doc(codigo);
        const alunoRef = alunosCol.doc(); // gera ID agora

        try {
          await db.runTransaction(async (tx) => {
            const codeSnap = await tx.get(codeRef);
            if (codeSnap.exists) throw new Error("duplicate");

            // cria aluno
            tx.set(alunoRef, {
              nome, codigo, isVoto: false,
              criadoEm: firebase.firestore.FieldValue.serverTimestamp()
            });

            // reserva o código
            tx.set(codeRef, {
              codigo, turmaId, alunoId: alunoRef.id,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          // deu certo
          return;
        } catch (err) {
          // se duplicado, tenta outro código; outros erros repassamos
          if (err.message !== "duplicate") throw err;
        }
      }
      throw new Error("Não foi possível gerar um código único. Tente novamente.");
    }

    // -----------------------------
    // 11) Página de Votação
    // -----------------------------
    voteCodeForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      voteMsg.innerHTML = ""; voteGroupsContainer.innerHTML = ""; voteStep2.classList.add("hidden");
      voteStudentDoc = null; voteTurmaId = null; voteAlunoRef = null;

      const raw = (voteCodeInput.value || "").trim();
      if (!/^\d{5}$/.test(raw)) { voteMsg.innerHTML = `<div class="alert alert-warning">Código inválido. Use 5 dígitos.</div>`; return; }
      const codigo = raw;

      try {
        // Consulta direta à coleção 'codes'
        const codeSnap = await db.collection("codes").doc(codigo).get();
        if (!codeSnap.exists) { voteMsg.innerHTML = `<div class="alert alert-danger">Código não encontrado.</div>`; return; }
        const { turmaId, alunoId } = codeSnap.data() || {};
        if (!turmaId || !alunoId) { voteMsg.innerHTML = `<div class="alert alert-danger">Código inválido ou corrompido.</div>`; return; }

        // Carrega aluno e turma
        const turmaRef = db.collection("turmas").doc(turmaId);
        const alunoRef = turmaRef.collection("alunos").doc(alunoId);
        const [alunoSnap, turmaSnap] = await Promise.all([alunoRef.get(), turmaRef.get()]);
        if (!alunoSnap.exists) { voteMsg.innerHTML = `<div class="alert alert-danger">Aluno não encontrado para este código.</div>`; return; }
        const aluno = alunoSnap.data();
        if (aluno.isVoto) { voteMsg.innerHTML = `<div class="alert alert-info">Este código já foi utilizado para votar.</div>`; return; }

        voteAlunoRef = alunoRef; voteTurmaId = turmaId; voteStudentDoc = alunoSnap;
        const turma = turmaSnap.data();

        // Carrega grupos
        const gruposSnap = await turmaRef.collection("grupos").orderBy("criadoEm", "asc").get();
        if (gruposSnap.empty) { voteMsg.innerHTML = `<div class="alert alert-warning">Nenhum grupo disponível nesta turma.</div>`; return; }

        voteStudentInfo.innerHTML = `
          <div class="alert alert-secondary">
            Turma: <strong>${turma?.nome || turmaId}</strong><br>
            Escola: <strong>${turma?.escola || "-"}</strong><br>
            Aluno (código): <span class="mono">${codigo}</span>
          </div>`;

        const formInner = document.createElement("div");
        gruposSnap.forEach(doc => {
          const g = doc.data(); const id = doc.id; const radioId = `grp_${id}`;
          const row = document.createElement("div"); row.className = "form-check";
          row.innerHTML = `
            <input class="form-check-input" type="radio" name="voteGroup" id="${radioId}" value="${id}">
            <label class="form-check-label" for="${radioId}">${g.nome}</label>`;
          formInner.appendChild(row);
        });
        voteGroupsContainer.appendChild(formInner); voteStep2.classList.remove("hidden");
      } catch (err) {
        console.error("Erro ao validar código:", err);
        voteMsg.innerHTML = `<div class="alert alert-danger">Erro ao validar código. Tente novamente.</div>`;
      }
    });

    voteForm.addEventListener("submit", async (e) => {
      e.preventDefault(); voteMsg.innerHTML = "";
      if (!voteStudentDoc || !voteTurmaId || !voteAlunoRef) { voteMsg.innerHTML = `<div class="alert alert-danger">Código não validado.</div>`; return; }
      const selected = document.querySelector('input[name="voteGroup"]:checked');
      if (!selected) { voteMsg.innerHTML = `<div class="alert alert-warning">Selecione um grupo para votar.</div>`; return; }
      const groupId = selected.value;

      try {
        await db.runTransaction(async (tx) => {
          const alunoSnap = await tx.get(voteAlunoRef);
          if (!alunoSnap.exists) throw new Error("Aluno não encontrado.");
          const aluno = alunoSnap.data();
          if (aluno.isVoto) throw new Error("Este código já foi utilizado.");

          const grupoRef = db.collection("turmas").doc(voteTurmaId).collection("grupos").doc(groupId);
          const grupoSnap = await tx.get(grupoRef);
          if (!grupoSnap.exists) throw new Error("Grupo inválido.");

          tx.update(voteAlunoRef, { isVoto: true, grupoVotado: groupId, votedAt: firebase.firestore.FieldValue.serverTimestamp() });
          tx.update(grupoRef, { votos: firebase.firestore.FieldValue.increment(1) });
        });

        voteMsg.innerHTML = `<div class="alert alert-success">Voto registrado com sucesso! Obrigado.</div>`;
        voteStep2.classList.add("hidden"); voteGroupsContainer.innerHTML = ""; voteStudentInfo.innerHTML = "";
        voteStudentDoc = null; voteTurmaId = null; voteAlunoRef = null; voteCodeInput.value = "";
      } catch (err) {
        console.error("Erro ao votar:", err);
        voteMsg.innerHTML = `<div class="alert alert-danger">Não foi possível registrar o voto: ${err.message}</div>`;
      }
    });

    // -----------------------------
    // 12) Inicialização
    // -----------------------------
    window.addEventListener("DOMContentLoaded", () => { resetToLogin(); });
  </script>

  <!--
    ===== Firestore Rules (atualizadas) =====

    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {

        // Professores (admin gerencia)
        match /professores/{profId} {
          allow read, write: if request.auth != null &&
                             request.auth.token.email == "adminvotacao@gmail.com";
          // (opcional) professor pode ler o próprio doc:
          allow read: if request.auth != null && resource.data.uid == request.auth.uid;
        }

        // Turmas
        match /turmas/{turmaId} {
          allow read: if true; // leitura pública (útil na votação)

          allow create: if request.auth != null &&
                        request.resource.data.professorUid == request.auth.uid &&
                        request.resource.data.escola is string;

          allow update, delete: if request.auth != null &&
                                resource.data.professorUid == request.auth.uid;

          // Grupos
          match /grupos/{grupoId} {
            allow read: if true;
            allow create: if request.auth != null &&
                          get(/databases/$(database)/documents/turmas/$(turmaId)).data.professorUid == request.auth.uid;
            allow update, delete: if request.auth != null &&
                          get(/databases/$(database)/documents/turmas/$(turmaId)).data.professorUid == request.auth.uid;

            // Permitir incremento +1 em votos publicamente (para a votação)
            allow update: if request.resource.data.votos == resource.data.votos + 1;
          }

          // Alunos
          match /alunos/{alunoId} {
            allow read: if true; // necessário para a votação
            allow create: if request.auth != null &&
                          get(/databases/$(database)/documents/turmas/$(turmaId)).data.professorUid == request.auth.uid;
            allow update, delete: if request.auth != null &&
                          get(/databases/$(database)/documents/turmas/$(turmaId)).data.professorUid == request.auth.uid;

            // Votação pública: só permitir isVoto: false -> true, sem alterar 'codigo'
            allow update: if
              request.resource.data.isVoto == true &&
              resource.data.isVoto == false &&
              request.resource.data.codigo == resource.data.codigo;
          }
        }

        // ===== Coleção global de códigos =====
        match /codes/{codeId} {
          // leitura pública para validação de voto
          allow read: if true;

          // criação somente por professor dono da turma; proíbe updates/deletes
          allow create: if request.auth != null
                        && request.resource.data.codigo == codeId
                        && request.resource.data.turmaId is string
                        && get(/databases/$(database)/documents/turmas/$(request.resource.data.turmaId)).data.professorUid == request.auth.uid
                        && !exists(/databases/$(database)/documents/codes/$(codeId));
          allow update, delete: if false;
        }
      }
    }

    Observação: com essa abordagem, não é necessário índice de collectionGroup.
    Para maior segurança, você pode mover a gravação do voto para Cloud Functions.
  -->
</body>

</html>